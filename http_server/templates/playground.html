<div class="container" id="playground">
  <div class="row">
    <div class="col-md-12">
      <link rel="stylesheet" href="{{ url_for('static', filename='node_modules/sage-widget/css/client.css') }}">
      <link href="{{ url_for('static', filename='node_modules/codemirror/lib/codemirror.css') }}" rel='stylesheet' type='text/css'/>
      <link href="{{ url_for('static', filename='node_modules/yasgui-yasqe/dist/yasqe.css') }}" rel='stylesheet' type='text/css'/>
      <div id='target'></div>

      <script type='text/javascript' src="{{ url_for('static', filename='node_modules/popper.js/dist/umd/popper.min.js') }}"></script>
      <script type='text/javascript' src="{{ url_for('static', filename='node_modules/sage-widget/js/jquery.tmpl.min.js') }}"></script>
      <script type='text/javascript' src="{{ url_for('static', filename='node_modules/knockout/build/output/knockout-latest.js') }}" charset="utf-8"></script>
      <script type='text/javascript' src="{{ url_for('static', filename='node_modules/codemirror/lib/codemirror.js') }}"></script>
      <script type='text/javascript' src="{{ url_for('static', filename='node_modules/yasgui-yasqe/dist/yasqe.js') }}"></script>
      <script type='text/javascript' src="{{ url_for('static', filename='node_modules/sage-client/sage-client-browser.js') }}"></script>
      <script type='text/javascript' src="{{ url_for('static', filename='node_modules/sage-widget/js/client_frontend.js') }}"></script>
      <script type='text/javascript'>
        jQuery(document).ready(function(){
        frontend = null;
        var queryList = [];

        findQuery = function(code){
          for (var i = 0; i < queryList.length; i++) {
            var query = queryList[i];
            if (query.code === code) {
              return query;
            }
          }
          return null;
        };

        findServ = function(dataset){
          var btns = jQuery('#datasetList')[0].children;
          for (var i = 0; i < btns.length; i++) {
            var btn = btns[i];
            if (btn.title.includes(dataset)) {
              return btn.title;
            }
          }
          return null;
        }
        frontend = new client_frontend('#target',sage);
        {% for dinfo in datasets %}
          var ds = "{{ dinfo }}";
          var parser = new DOMParser;
          var dom = parser.parseFromString(
              '<!doctype html><body>' + ds,
              'text/html');
          var decodedString = dom.body.textContent;
          var toParse = decodedString.replace(/\'/g,"\"");
          toParse = toParse.replace(/\\"/g,"'");
          toParse = toParse.replace(/("maxResults": inf,)/g,"")
          toParse = toParse.replace(/("value": "(\n|.)*?(?="))/g,function (match){
            var ret = match.replace(/\n/g,"\\n");
            return ret.replace(/\t/g,"\\t");
          })
          var dataset = JSON.parse(toParse);
          var qIndex;
          if (dataset.queries != null) {
            for (var i = 0; i < dataset.queries.length; i++) {
              var currQuery = dataset.queries[i];
              qIndex = queryList.length + 1;
              var toAdd = {code:("q"+qIndex), dataset: dataset.name, description : currQuery.name, query: currQuery.value};
              queryList.push(toAdd);
            }
          }
          var hostname = window.location.href;
          if (hostname.indexOf("#") > -1  ) {

            hostname = hostname.slice(0,hostname.indexOf('#') - 1);
          }
          else {
            hostname = hostname.slice(0,-1);
          }
          var urlDS = hostname + "{{ url_for('sparql-interface.sparql_query', dataset_name=dinfo["name"]) }}";
          var html = '<a class="dropdown-item" title="' + urlDS + '">'+dataset.name+'</a>'
          jQuery('#datasetList').append(html);
        {% endfor %}

        for (var i = 0; i < queryList.length; i++) {
          var query = queryList[i];
          var html = '<a class="dropdown-item" title="' + query.code + '">'+query.description+'</a>';
          jQuery('#queryList').append(html);
        }

        var btnsQueries = jQuery('#queryList')[0].children;

        var foundDefault = false;
        var cpt = 0;
        while (!foundDefault) {
          var defQuery = findQuery(btnsQueries[cpt].title);
          if (defQuery != null) {
            var serv = findServ(defQuery.dataset);
            if (serv != null) {
              jQuery('#sparql-query-desc-text').val(defQuery.description);
              frontend.yasqe.setValue(defQuery.query);
              jQuery('#sparql-server-text').val(serv);
              foundDefault = true;
            }
            else {
              cpt++;
            }
          }
          else {
            cpt++;
          }
        }

        for (var i = 0; i < btnsQueries.length; i++) {
          btnsQueries[i].onclick = function(sender){
            var query = findQuery(sender.target.title);
            if (query != null) {
              var serv = findServ(query.dataset);
              if (serv != null) {
                jQuery('#sparql-query-desc-text').val(query.description);
                frontend.yasqe.setValue(query.query);
                jQuery('#sparql-server-text').val(serv);
              }
            }
          };
        }

        var btns = jQuery('#datasetList')[0].children;
        // jQuery('#sparql-server-text').val(btns[0].title);
        for (var i = 0; i < btns.length; i++) {
          btns[i].onclick = function(sender){
            jQuery('#sparql-server-text').val(sender.target.title);
          };
        }
        frontend.yasqe.on("inputRead",function(){
          jQuery('#sparql-query-desc-text').val("Custom Query");
        });
      });
      </script>
    </div>
  </div>
</div>
